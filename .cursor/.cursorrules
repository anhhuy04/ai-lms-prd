# AI LMS Project Rules & Standards (2026)
rules li√™n quan b·∫Øt bu·ªôc ph·∫£i ƒë·ªçc .clinerules
## 1. Professional Tech Stack Standards
Always implement features using these specific libraries:
- State Management: Riverpod with @riverpod generator (Never use old Provider/ChangeNotifier).
- Routing: GoRouter v14+ (Declarative routing, type-safe).
- Routing usage: Kh√¥ng d√πng `Navigator.push*` cho screen; d√πng `context.go/push/pushNamed` v·ªõi h·∫±ng `AppRoute`. Ngo·∫°i l·ªá: dialog/bottom sheet/tab n·ªôi b·ªô.
- Models: Freezed & JsonSerializable (Always immutable).
- Local DB: Drift (Relational) & Flutter Secure Storage (Sensitive data).
- Networking: Dio + Retrofit (Interface-based API).
- Environment: Envied (Compile-time secrets).
- UI: Flutter ScreenUtil (Responsive) & Shimmer (Loading).
- QR Codes: pretty_qr_code (Use QrHelper utility class for consistency).
- Error Reporting: Sentry Flutter (All errors must be reported).
- Logging: logger package (Use AppLogger wrapper, never print()).

## 1.1 Conflict Resolution Priority (Source of Truth)
If any documents/rules conflict, follow this priority:
1) `.clinerules`
2) `.cursor/.cursorrules`
3) `.cursor/skills/**` (skills handbook, playbooks)
4) `memory-bank/**`
5) `docs/**` (some sections may be legacy)

## 1.2 Sentry Reporting (Critical Flows)
All critical flows MUST be reported to Sentry when errors occur (at least):
- Auth flows (login/register/logout, session restoration)
- Data writes (create/update/delete) to Supabase
- Crash/unhandled exceptions
- DataSource/Repository boundary errors that block user tasks

## 2. Mandatory MCP & Web Usage Policy
You MUST act as an "Always-Learning" AI. Follow these protocols:
- **Library Context:** Before implementing any feature using the tech stack above, if your internal knowledge is older than 2025, you MUST use `MCP Fetch` to read the latest documentation from:
  - Riverpod: https://riverpod.dev
  - GoRouter: https://pub.dev/packages/go_router
  - Drift: https://drift.simonbinder.eu
- **Automated Research:** If you encounter a bug or a complex implementation (e.g., Deep Linking, OAuth2), use `@Web` to find the 2025-2026 best practices before suggesting code.
- **Deep Fetching:** Use MCP Fetch on specific `/latest/` or `/example/` subpages of a package on pub.dev to understand the exact API surface.

## 3. Architecture & Clean Code Rules
- Follow Clean Architecture: `domain` (entities/interfaces), `data` (models/repositories/datasources), `presentation` (views/providers).
- **Naming Convention:**
  - Providers: `[feature]Provider`, `[feature]NotifierProvider`.
  - UI: `[Feature]Screen`, `[Feature]Widget`.
  - Utilities: `[Feature]Helper`, `[Feature]Utils`.
- **Error Handling:** Never use `print()`. Use `AppLogger` (structured logging) and wrap critical flows with Sentry reporting.
- **Race Condition:** Always use `CancelToken` in Dio for search or fast-switching UI to prevent race conditions.
- **QR Code Generation:** Always use `QrHelper` utility class from `lib/core/utils/qr_helper.dart` for consistency.
- **Code Generation:** Always run `flutter pub run build_runner build --delete-conflicting-outputs` after modifying Freezed/JsonSerializable/Envied classes.

### 3.2 Supabase RLS & Data Access Conventions (2026-01-30)
- All Supabase **public** tables exposed via PostgREST (ƒë·∫∑c bi·ªát: `profiles`, `classes`, `schools`, `groups`, `class_teachers`, `class_members`, `group_members`, question/assignment tables) MUST have RLS enabled + explicit policies for admin / teacher / student.
- When writing new RLS policies, ALWAYS use `(select auth.uid())` instead of `auth.uid()` directly (as per Supabase Database Advisor) to avoid per-row re-evaluation.
- For complex writes touching multiple tables (e.g. publish assignment + questions + distributions), prefer a **single RPC (security definer + explicit auth checks)** over multiple client-side round-trips.

### 3.1 Error Prevention Rules (CRITICAL - Learn from Mistakes)
**MANDATORY:** ƒê·ªçc `.cursor/rules/error-prevention-rules.md` tr∆∞·ªõc khi implement feature m·ªõi.

**Quick Checklist:**
- ‚úÖ **GoRouter Routes**: Route c·ª• th·ªÉ PH·∫¢I ƒë·ª©ng TR∆Ø·ªöC route c√≥ parameter (tr√°nh route matching conflict)
- ‚úÖ **Provider Duplication**: Grep t√™n provider tr∆∞·ªõc khi t·∫°o m·ªõi (tr√°nh "already defined" error)
- ‚úÖ **Null Safety**: LU√îN ki·ªÉm tra null v√† empty tr∆∞·ªõc khi access collection elements
- ‚úÖ **Dependencies**: Th√™m v√†o `pubspec.yaml` v√† ch·∫°y `flutter pub get` TR∆Ø·ªöC KHI import
- ‚úÖ **Requirement Clarification**: H·ªèi r√µ behavior tr∆∞·ªõc khi implement (ƒë·∫∑c bi·ªát v·ªõi delete/update operations)
- ‚úÖ **Import Management**: Ch·∫°y `read_lints` sau khi vi·∫øt code ƒë·ªÉ ki·ªÉm tra missing imports
- ‚úÖ **Code Generation**: Ch·∫°y build_runner sau khi thay ƒë·ªïi Freezed/JsonSerializable classes
- ‚úÖ **Testing**: Test happy path, error cases, v√† edge cases sau khi implement

**Xem chi ti·∫øt:** `.cursor/rules/error-prevention-rules.md`

## 4. Documentation & Memory Bank
- After every significant change, remind me to update the `memory-bank/` files.
- Always check `@Memory_Bank` before starting a new task to ensure continuity.
- **Session notes b·∫Øt bu·ªôc:** ƒê·∫ßu m·ªói phi√™n ph·∫£i ƒë·ªçc `docs/ai/session-notes.md` ƒë·ªÉ n·∫Øm context; cu·ªëi m·ªói phi√™n (ho·∫∑c khi ho√†n t·∫•t m·ªôt nh√°nh c√¥ng vi·ªác) ph·∫£i append entry m·ªõi theo template trong file ƒë√≥ (kh√¥ng overwrite). C√≥ th·ªÉ d·ªçn c√°c entry c≈© ƒë√£ ƒë∆∞·ª£c thay th·∫ø/s·ª≠a khi quy tr√¨nh log ƒë√£ ·ªïn ƒë·ªãnh v√† c√≥ entry m·ªõi thay th·∫ø r√µ r√†ng.

## 5. UI/UX Rules
- Use `SmartHighlightText` for all search results (Supports Vietnamese diacritics removal).
- Ensure all screens use `AutomaticKeepAliveClientMixin` where state preservation is needed.
- Keyboard MUST be dismissed on scroll: `keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag`.

# Flutter Debug & Development Rules

You are an expert Flutter & Dart Engineer. Your goal is to monitor, diagnose, and fix issues in real-time by analyzing the Debug Console and codebase.
## Log Access
- Always read the file `logs.txt` at the root directory to see the latest runtime errors.
- If `logs.txt` is updated, analyze the new lines immediately.
## üõ† Debugging Workflow
- **Monitor Terminal:** Actively watch the Debug Console for "Exception", "Error", "Null check operator used on a null value", or "RenderFlex overflowed".
- **Stack Trace Analysis:** When an error occurs, analyze the stack trace to identify the exact file and line number.
- **Auto-Fix Protocol:** 1. Identify the root cause (State management, UI constraint, or Logic).
    2. Propose a fix that aligns with the project's state management.
    3. Ensure no breaking changes to existing UI logic.

## üèó State Management Preference
# B·∫°n h√£y gi·ªØ l·∫°i ph·∫ßn b·∫°n ƒëang d√πng v√† x√≥a c√°c ph·∫ßn kh√°c:
- **Provider/Riverpod:** Use `ref.read` for events and `ref.watch` for UI updates. Avoid unnecessary rebuilds.
- **Bloc/Cubit:** Ensure all states are immutable. Use `context.read<T>().add()` for events. Check if `equatable` is implemented.
- **GetX:** Use `Get.find` and ensure controllers are properly disposed.

## üé® UI & Rendering Rules
- If a "RenderFlex overflow" occurs, prioritize using `Flexible`, `Expanded`, or `SingleChildScrollView`.
- Always check for null-safety before accessing properties in the Widget tree.
- Use `LayoutBuilder` for responsive debugging.

## ‚ö° Real-time Fix Behavior
- When I say "Fix this", look at the last 50 lines of the @Terminal.
- Automatically check if the issue is related to missing dependencies in `pubspec.yaml`.
- If a fix requires a "Hot Reload" or "Hot Restart", notify me after applying the code change.

## 6. Widget Composition Pattern (Assignment List)
**MANDATORY:** Khi t·∫°o c√°c m√†n h√¨nh list t∆∞∆°ng t·ª± nhau, PH·∫¢I s·ª≠ d·ª•ng Composition Pattern thay v√¨ copy-paste code.

### 6.1 Assignment List Widgets Structure
Location: `lib/presentation/views/assignment/teacher/widgets/assignment_list/`

**Core Widgets:**
- `AssignmentCard`: Reusable card widget ƒë·ªÉ hi·ªÉn th·ªã m·ªôt assignment
  - Nh·∫≠n config t·ª´ b√™n ngo√†i (badge, action, metadata)
  - Kh√¥ng hardcode logic, ch·ªâ render UI
- `AssignmentListView`: List view wrapper v·ªõi pull-to-refresh
  - Compose AssignmentCard v√† EmptyState
  - X·ª≠ l√Ω refresh logic
- `AssignmentEmptyState`: Empty state widget
  - Factory methods: `.draft()`, `.published()`
- `AssignmentErrorState`: Error state widget v·ªõi retry
- `AssignmentCardConfig`: Config classes (Badge, Action, Metadata)
- `AssignmentDateFormatter`: Utility class format dates

**Design Principles:**
1. **Composition over Configuration**: T√°ch th√†nh widget nh·ªè, compose l·∫°i
2. **Single Responsibility**: M·ªói widget ch·ªâ l√†m 1 vi·ªác
3. **Open/Closed**: D·ªÖ m·ªü r·ªông, kh√¥ng c·∫ßn s·ª≠a code c≈©
4. **Dependency Inversion**: Widget nh·∫≠n config t·ª´ b√™n ngo√†i

**Usage Pattern:**
```dart
// Screen ch·ªâ compose, kh√¥ng c√≥ logic UI ph·ª©c t·∫°p
AssignmentListView(
  assignments: filteredAssignments,
  badgeConfig: AssignmentBadgeConfig.draft,
  actionBuilder: (assignment) => AssignmentActionConfig(...),
  metadataConfig: AssignmentMetadataConfig.draft,
  emptyState: AssignmentEmptyState.draft(),
  onRefresh: () => refresh(),
)
```

**Khi n√†o √°p d·ª•ng:**
- ‚úÖ C√≥ 2+ m√†n h√¨nh list t∆∞∆°ng t·ª± nhau (>70% code gi·ªëng)
- ‚úÖ C·∫ßn t√°i s·ª≠ d·ª•ng UI components
- ‚úÖ Mu·ªën d·ªÖ maintain v√† m·ªü r·ªông

**Khi n√†o KH√îNG √°p d·ª•ng:**
- ‚ùå Ch·ªâ c√≥ 1 m√†n h√¨nh duy nh·∫•t
- ‚ùå C√°c m√†n h√¨nh kh√°c nhau ho√†n to√†n
- ‚ùå Over-engineering cho use case ƒë∆°n gi·∫£n

**Best Practices:**
- ‚úÖ S·ª≠ d·ª•ng preset configs: `AssignmentBadgeConfig.draft`, `AssignmentMetadataConfig.published`
- ‚úÖ T√°ch utility functions: `AssignmentDateFormatter`
- ‚úÖ Factory methods cho empty states: `AssignmentEmptyState.draft()`
- ‚úÖ Test t·ª´ng widget nh·ªè ri√™ng bi·ªát
- ‚ùå Kh√¥ng hardcode config trong widget
- ‚ùå Kh√¥ng copy-paste code, d√πng l·∫°i widgets
- ‚ùå Kh√¥ng t·∫°o config class qu√° ph·ª©c t·∫°p

**Xem chi ti·∫øt:** `docs/architecture/assignment_list_widgets_composition_pattern.md`
